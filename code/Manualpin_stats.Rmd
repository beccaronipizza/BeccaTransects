---
title: "Manualpin_stats"
author: "Becca Morris"
date: "2024-02-03"
output: html_document
---

```{r}
library(readxl)
library(tidyverse)
library(dplyr)
library(ggrepel)
library(ggpubr)
library(emmeans)
library(magrittr)
library(performance)

setwd("~/GitHub/BeccaTransects/data")

sedpindata <- read_xlsx("Sediment_Pin_Data.xlsx", sheet = "All_Data")
```


#2. prepping the dataframe
```{r}
sedpins <- sedpindata %>% 
  mutate(Date = paste0(Year, "-", Month)) %>% #make new column combining year and month into date
  mutate_at(c('Upper', 'Middle','Lower'), as.numeric) %>% #make Upper and Middle columns numeric (have NA's)
  select(-c("Notes")) %>% #remove "Notes" column
  mutate(across(where(is.numeric), ~round(., 1))) %>%  #round values to one decimal point
  group_by(Pin_ID, Shoreline_End) %>% 
  rename(Transect_ID = Pin_ID)
#arrange(Date, .by_group = TRUE) %>% 



sedpinmetadata <- read_xlsx("~/GitHub/BeccaTransects/data/Sediment_Pin_Data.xlsx", sheet = "Metadata")

sedpinmetadata <-select(sedpinmetadata, -c("Shoreline_End"))

SedPinDataMerged <- full_join(sedpins, sedpinmetadata, by = "Transect_ID")


sedpinchange <- SedPinDataMerged %>%   
  mutate(UpperDiff = (last(Upper) - first(Upper))*-1) %>% 
  mutate(MiddleDiff = (last(Middle) - first(Middle))*-1) %>% 
  mutate(LowerDiff = (last(Lower) - first(Lower))*-1) %>% 
  #mutate(UpperDiff = ifelse(is.na(UpperDiff) & Pin_ID == "C1-BW6", 3.2, UpperDiff)) %>% 
  #mutate(UpperDiff = ifelse(is.na(UpperDiff) & Pin_ID == "C1-L5", 3.2, UpperDiff)) %>%
  select(-c('Month',`Month_#`, 'Year', 'Date', 'Upper', 'Middle', 'Lower')) %>% #remove all unnecessary columns
  distinct() %>%  #this removes repeated values for each month's calculation
  mutate(Shoreline_End = factor(Shoreline_End, levels = c("west", "east"))) %>%
  pivot_longer(UpperDiff:LowerDiff, names_to = "Pin_Location", values_to = "Sediment_Change") %>% 
  mutate(Pin_Location = as.factor(Pin_Location)) #make Pin_Location a factor
```

# 3. Running a basic GLM: without taking into account interactions (use #4 below):
```{r}
hist(sedpinchange$Sediment_Change)

glm1 <- glm(Sediment_Change ~ Shoreline_End + Pin_Location + Log_Presence, data = sedpinchange, family = 'gaussian')

plot(glm1)

summary(glm1)

anova(glm1, test = "F")
```
##Results: 

#A. A Warning Popped up for the Residuals vs. Leverage test that there were 2 data points that exceeded a leverage of 1. These data points were listed as "reference" under Log_Presence, and therefore, seemed to be causing wonky results.

#B. the glm shows strong main effects for shoreline end and pin location PLUS a "trend" for all three variables combined. Again, we think the trend may have something to do with the reference pin data since there were only four of them.

# We decided to remove the reference pin data to see what results we get int he next step...


# 4. Running a GLM taking interactions into account:
```{r}
hist(sedpinchange$Sediment_Change[sedpinchange$Log_Presence != "reference"])

glm2 <- glm(Sediment_Change ~ Shoreline_End * Pin_Location * Log_Presence, data = sedpinchange[sedpinchange$Log_Presence != "reference",], family = 'gaussian')

plot(glm2)

summary(glm2)

step(glm2) #AIC only measures the relative quality of models. The lower the AIC value the better, but only if the precision of your answer is not of the utmost importance. These AIC results suggest that shoreline and pin location have the biggest effect.

#If you want to run the chi^2 test use the drop 1 function found on pg. 222 of "Mixed Effect Models..."

anova(glm2, test = "F") #the F test confirms the AIC results from above.

```
##Results:

#A. Leverage cleared up

#B. Pin location  (u,m,l) most important for determining significance. Shoreline end also sig. but not as much as pin location. ie. Only strong support for Shoreline End and Pin Location individually having a strong effect and no more trend for all three combined. This is good! Much easier to explain in thesis.


#Further tests:
```{r}
emmeans(glm2, specs = pairwise ~ Shoreline_End:Pin_Location) ## I get output but I don't know how to interpret it.

check_normality(glm2) ##look into this!

check_heteroscedasticity(glm2)  ## when the standard deviations of a predicted variable, monitored over different values of an independent variable or as related to prior time periods, are non-constant.
```
#### Since pin location showed the most significance, then I will split my data into the three zones and test seperately.

#Upper Zone:
```{r}
sedpinchange_U <- sedpinchange[sedpinchange$Pin_Location == "UpperDiff" & !(sedpinchange$Log_Presence == "reference"),]

hist(sedpinchange_U$Sediment_Change)

glm3 <- glm(Sediment_Change ~ Shoreline_End * Log_Presence, data = sedpinchange_U, family = 'gaussian')

plot(glm3) #!! There are three big outliers in this data according to the QQ plots: points 20-22 which are C2-L27, C2-BW27, and C2-L22. Checked field notes with excel spreadsheet and values are correct. 



### Going to test without the outliers to see if it makes a difference:
sedpinchange_U_out <- sedpinchange_U[-c(20:22),]  #remove the rows that contain the outliers

hist(sedpinchange_U_out$Sediment_Change)

glm3 <- glm(Sediment_Change ~ Shoreline_End * Log_Presence, data = sedpinchange_U_out, family = 'gaussian')

plot(glm3)

summary(glm3)

step(glm3) #AIC only measures the relative quality of models. The lower the AIC value the better, but only if the precision of your answer is not of the utmost importance. These AIC results suggest that shoreline  end east and log prosence no log have the biggest effect.

#If you want to run the chi^2 test use the drop 1 function found on pg. 222 of "Mixed Effect Models..."

anova(glm3, test = "F") #the F test Indicates that with the outliers removed, shoreline end has the biggest effect (Pr(>F) = 0.0002549) and log presence has a slight effect (Pr(>F) = 0.224743).  

#Further testing:
check_heteroscedasticity(glm3)  ## Heteroscedasticity (the violation of homoscedasticity) is present when the size of the error term differs across values of an independent variable.  The impact of violating the assumption of homoscedasticity is a matter of degree, increasing as heteroscedasticity increases.The problem that heteroscedasticity presents for regression models is simple.  Recall that ordinary least-squares (OLS) regression seeks to minimize residuals and in turn produce the smallest possible standard errors.  By definition, OLS regression gives equal weight to all observations, but when heteroscedasticity is present, the cases with larger disturbances have more “pull” than other observations.  In this case, weighted least squares regression would be more appropriate, as it down-weights those observations with larger disturbances.

#*** This data IS homescedastic
```

#Middle Zone:
```{r}
sedpinchange_M <- sedpinchange[sedpinchange$Pin_Location == "MiddleDiff" & !(sedpinchange$Log_Presence == "reference"),]

hist(sedpinchange_M$Sediment_Change)

glm4 <- glm(Sediment_Change ~ Shoreline_End * Log_Presence, data = sedpinchange_M, family = 'gaussian')

plot(glm4)

summary(glm4)

step(glm4) #AIC only measures the relative quality of models. The lower the AIC value the better, but only if the precision of your answer is not of the utmost importance. 

#If you want to run the chi^2 test use the drop 1 function found on pg. 222 of "Mixed Effect Models..."

anova(glm4, test = "F") #the F test shows no significance for the effects of shoreline end, log presence, or a combination of the two. 

#Further testing:
check_normality(glm4) ##look into this!

check_heteroscedasticity(glm4)  ## when the standard deviations of a predicted variable, monitored over different values of an independent variable or as related to prior time periods, are non-constant.

# *This data IS homoscedastic!
```

#Lower Zone:
```{r}
sedpinchange_L <- sedpinchange[sedpinchange$Pin_Location == "LowerDiff" & !(sedpinchange$Log_Presence == "reference"),]

hist(sedpinchange_L$Sediment_Change)

glm5 <- glm(Sediment_Change ~ Shoreline_End * Log_Presence, data = sedpinchange_L, family = 'gaussian')

plot(glm5)

summary(glm5)

step(glm5) #AIC only measures the relative quality of models. The lower the AIC value the better, but only if the precision of your answer is not of the utmost importance. 

#If you want to run the chi^2 test use the drop 1 function found on pg. 222 of "Mixed Effect Models..."

anova(glm5, test = "F") #the F test shows that shoreline end only has an effect on the results. 

#Further testing:
check_heteroscedasticity(glm5)  ## when the standard deviations of a predicted variable, monitored over different values of an independent variable or as related to prior time periods, are non-constant.

#* This data IS homoscedastic.
```

